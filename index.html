<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jutup bez cenzóry</title>
<style>
/* -------------------- Theme / root -------------------- */
:root {
  --bg: #0b0c10;
  --card: #0f1113;
  --muted: #9aa0a6;
  --accent: #5ad0ff;
  --gap: 12px;
  --card-min: 300px;       /* minimalna szerokość karty przed zawijaniem */
  --touch-padding: 14px;   /* padding dla elementów dotykowych */
}

/* -------------------- Base -------------------- */
* { box-sizing: border-box; }
html,body { height:100%; }
body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(180deg, #07080a, var(--bg));
  color: #eaf6ff;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding: 18px;
  -webkit-tap-highlight-color: transparent;
}
.wrap { max-width: 1200px; margin: 0 auto; }

/* -------------------- Header / Controls -------------------- */
header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
h1 { font-size:18px; margin:0; font-weight:600; }
.controls { display:flex; gap:8px; align-items:center; }
button {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.04);
  color: inherit;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}
button.primary {
  background: linear-gradient(90deg, #062235, #043b5a);
  border: 1px solid rgba(90, 208, 255, 0.12);
}

/* -------------------- Grid (responsive) -------------------- */
/* auto-fit + minmax daje płynne zmniejszanie/zmienianie liczby kolumn */
.grid {
  display: grid;
  gap: var(--gap);
  grid-template-columns: repeat(auto-fit, minmax(var(--card-min), 1fr));
}

/* -------------------- Card / Thumb / Meta -------------------- */
.card {
  background: var(--card);
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,0.02);
  transition: transform .12s, box-shadow .12s;
  display: flex;
  flex-direction: column;
  min-height: 220px;
  touch-action: manipulation;
}

/* Proponowane proporcje miniatury - większe na mobile */
.thumb {
  height: auto;
  background: linear-gradient(180deg,#0b0d11,#0e1115);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  width:100%;
  aspect-ratio: 16 / 9;    /* domyślnie 16:9 — dobre na desktop */
  overflow: hidden;
}

/* Obrazek zawsze przykrywa obszar miniatury */
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
  -o-object-fit: cover;
}

/* folder badge (ikonka) */
.folder-icon { width:44px; height:44px; display:inline-block; vertical-align:middle; }

/* Meta: tytuł i subtekst */
.meta { padding:10px; font-size:13px; display:flex; flex-direction:column; gap:6px; }
.title {
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-weight:600;
  font-size: 14px;
}
.sub { color:var(--muted); font-size:12px; margin-top:2px; }

/* Hover effect */
.card:hover { transform: translateY(-6px); box-shadow: 0 14px 30px rgba(0,0,0,0.5); }

/* -------------------- Modal / Player / Description -------------------- */
.modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.7);
  z-index:60;
  padding:20px;
}
.modal.open { display:flex; }
.player-box {
  width:95%;
  max-width:1100px;
  background:#071018;
  border-radius:10px;
  padding:12px;
  max-height: calc(100vh - 10px);
  overflow: auto;
  display: flex;
  flex-direction: column;
}
video { width:100%; height:auto; border-radius:8px; background:black; max-height:60vh; }
.row { display:flex; gap:8px; align-items:center; }
.status { color:var(--muted); font-size:13px; }
.empty {
  padding:28px;
  border-radius:10px;
  background:rgba(255,255,255,0.02);
  text-align:center;
  color:var(--muted);
}

/* Breadcrumb / badges */
.breadcrumb { display:flex; gap:6px; align-items:center; color:var(--muted); font-size:13px; }
.breadcrumb a { color:var(--muted); text-decoration:none; }
.badge { font-size:11px; color:var(--muted); background:rgba(255,255,255,0.02); padding:6px; border-radius:8px; }

/* --- Opis pod odtwarzaczem --- */
.desc-toggle {
  margin-top: 10px;
  display:flex;
  align-items:center;
  gap:8px;
}
.desc-toggle button {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.04);
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}
.desc-wrapper {
  margin-top: 10px;
  background: rgba(255,255,255,0.01);
  border-radius: 8px;
  padding: 10px;
  color: #dceffb;
  font-size: 14px;
  line-height: 1.45;
  overflow: hidden;
  max-height: 0;
  transition: max-height 260ms ease;
}
.desc-wrapper.open {
  max-height: 480px;
  overflow: auto;
}
.desc-meta {
  color: var(--muted);
  font-size: 12px;
  margin-top: 8px;
}

/* -------------------- Utilities / Accessibility -------------------- */
button:focus, a:focus { outline: 3px solid rgba(90,208,255,0.12); outline-offset:2px; }

/* -------------------- Responsive tuning / Breakpoints -------------------- */

/* Very wide screens: wymuś dokładnie 3 kolumny (opcjonalne) */
@media (min-width: 1400px) {
  .grid { grid-template-columns: repeat(3, 1fr); gap: calc(var(--gap) * 1.1); }
  :root { --card-min: 300px; }
}

/* Medium / tablet: 2 kolumny */
@media (max-width: 1000px) {
  .grid { grid-template-columns: repeat(2, 1fr); gap: calc(var(--gap) * 1.15); }
  :root { --card-min: 260px; --gap: 10px; }
  .meta { padding: 12px; font-size:14px; }
  .title { font-size: 15px; }
}

/* Mobile: 1 kolumna, większe, thumb-friendly karty */
@media (max-width: 600px) {
  :root { --card-min: 100%; --gap: 14px; --touch-padding: 16px; }
  .grid { grid-template-columns: 1fr; gap: calc(var(--gap) * 1.4); }
  .card {
    min-height: 260px;
    border-radius: 12px;
  }
  /* bardziej pionowy / większy obraz -> większa czytelność i większy obszar dotyku */
  .thumb { aspect-ratio: 3 / 2; }
  .meta { padding: calc(var(--touch-padding) + 6px); }
  .title { font-size: clamp(18px, 4.5vw, 22px); white-space: normal; }
  .sub { font-size: 14px; color: var(--muted); }
  header, .controls { gap: 10px; }
  button { padding: 12px 14px; font-size: 15px; border-radius: 10px; }
  .wrap { padding: 14px; }
}

/* Very small phones: jeszcze większe dotykowo */
@media (max-width: 420px) {
  .card { min-height: 300px; }
  .thumb { aspect-ratio: 4 / 3; }
  .meta { padding: 16px; }
  .title { font-size: 20px; }
}

/* Jeśli chcesz bardziej „kwadratowe” miniatury, zamień aspect-ratio powyżej na 1/1 */
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Jutup bez cenzóry</h1>
      <div id="breadcrumb" class="breadcrumb" aria-label="Ścieżka"></div>
    </div>
    <div class="controls">
      <button id="upBtn" title="Idź do góry">⬆ Up</button>
      <button id="refreshBtn" class="primary">⭮ Odśwież</button>
      <label class="row status" id="status">Ładowanie…</label>
    </div>
  </header>
  <main>
    <div id="empty" class="empty" style="display:none">Brak plików/ folderów w katalogu <code>./videos/</code>. Dodaj <code>manifest.json</code> lub włącz listing katalogów.</div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>
</div>
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="player-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <strong id="modalTitle">Tytuł</strong>
        <div id="modalMeta" style="color:var(--muted);font-size:13px"></div>
      </div>
      <div><button id="closeBtn">✕ Zamknij</button></div>
    </div>
    <video id="videoPlayer" controls playsinline></video>

    <!-- toggle (tylko przycisk) - bez tekstu pod przyciskiem -->
    <div class="desc-toggle" id="descToggleRow" style="display:none">
      <button id="toggleDescBtn" aria-expanded="false">Pokaż opis</button>
    </div>

    <!-- wrapper - pusty dopóki opis nie zostanie otwarty -->
    <div id="descWrapper" class="desc-wrapper" aria-hidden="true"></div>

  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
(async function() {
  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  const empty = document.getElementById('empty');
  const refreshBtn = document.getElementById('refreshBtn');
  const modal = document.getElementById('modal');
  const videoPlayer = document.getElementById('videoPlayer');
  const modalTitle = document.getElementById('modalTitle');
  const modalMeta = document.getElementById('modalMeta');
  const closeBtn = document.getElementById('closeBtn');
  const upBtn = document.getElementById('upBtn');
  const breadcrumbEl = document.getElementById('breadcrumb');

  // opis controls
  const descToggleRow = document.getElementById('descToggleRow');
  const toggleDescBtn = document.getElementById('toggleDescBtn');
  const descWrapper = document.getElementById('descWrapper');

  const baseVideosUrl = new URL('./videos/', location.href).href;
  let currentPath = '';
  let pathStack = [];
  let library = [];
  const defaultFolderDataUrl = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 24 24' fill='none'><path d='M3 7a2 2 0 0 1 2-2h3l2 2h7a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z' fill='%23ffd166' stroke='%23ffb347' stroke-width='0.5'/></svg>`);

  async function fetchManifest(path) {
    try {
      const url = new URL('manifest.json', baseVideosUrl+path).href;
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) return null;
      const json = await res.json();
      if(!json) return null;
      const items = Array.isArray(json)?json:[json];
      return items.map(item=>{
        if(item.dir){
          return {type:'dir',name:item.title||item.dir.replace(/\/$/,'').split('/').pop(),raw:item.dir,size:null,duration:null,thumbUrl:null, description: item.opis || item.description || ''};
        }
        if(item.file){
          const filePaths = Array.isArray(item.file)?item.file:[item.file];
          let thumbUrl = null;
          if(item.miniatura){
            try{thumbUrl=new URL(encodeURIComponent(item.miniatura),baseVideosUrl+path).href}catch(e){}
          }
          return {type:'file',name:item.title||filePaths[0],raw:filePaths,size:null,duration:null,thumbUrl, description: item.opis || item.description || ''};
        }
        return null;
      }).filter(Boolean);
    } catch(e){return null;}
  }

  async function statFile(url){try{const r=await fetch(url,{method:'HEAD'});if(!r.ok)return null;const s=r.headers.get('content-length');return s?parseInt(s,10):null}catch(e){return null}}

  function humanSize(bytes){if(!bytes&&bytes!==0)return '—';if(bytes<1024)return bytes+' B';const units=['KB','MB','GB','TB'];let i=-1,b=bytes;do{b/=1024;i++}while(b>=1024&&i<units.length-1);return b.toFixed(b>=10?0:1)+' '+units[i]}
  function formatDuration(sec){return ''; if(!sec&&sec!==0)return '—';const s=Math.floor(sec%60).toString().padStart(2,'0');const m=Math.floor((sec/60)%60).toString().padStart(2,'0');const h=Math.floor(sec/3600);return h?`${h}:${m}:${s}`:`${m}:${s}`}

  function renderBreadcrumb(){
    breadcrumbEl.innerHTML='';
    const rootLink=document.createElement('a');
    rootLink.href='#'; rootLink.textContent='videos/';
    rootLink.addEventListener('click',e=>{e.preventDefault();navigateTo('')});
    breadcrumbEl.appendChild(rootLink);
    let acc='';
    pathStack.forEach(part=>{
      acc+=part+'/';
      const sep=document.createElement('span'); sep.textContent=' / '; breadcrumbEl.appendChild(sep);
      const link=document.createElement('a'); link.href='#'; link.textContent=part+'/'; link.addEventListener('click',e=>{e.preventDefault();navigateTo(acc)});
      breadcrumbEl.appendChild(link);
    });
  }

  async function navigateTo(path){currentPath=path||'';pathStack=currentPath?currentPath.replace(/\/$/,'').split('/') : []; renderBreadcrumb(); await loadLibrary()}

  async function loadLibrary(){
    status.textContent='Szukam plików/folderów…';
    library=[]; grid.innerHTML='';
    const manifestItems=await fetchManifest(currentPath);
    if(manifestItems?.length){await processEntries(manifestItems);status.textContent=`${library.length} załadowanych elementów`; return;}
    status.textContent='Brak plików lub brak dostępu do listingu katalogu.'; empty.style.display='block'; grid.innerHTML='';
  }

  async function processEntries(entries){
    empty.style.display='none';
    for(const entry of entries){
      const item={type:entry.type,name:entry.name,url:Array.isArray(entry.raw)?new URL(entry.raw[0],baseVideosUrl+currentPath).href:new URL(entry.raw,baseVideosUrl+currentPath).href,size:null,duration:null,thumbUrl:entry.thumbUrl||null, description: entry.description||''};
      library.push(item); renderGrid();
      if(item.type==='file'){
        const size=await statFile(item.url); if(size)item.size=size;
        if(!item.thumbUrl){try{const candidate=new URL(item.name.replace(/\.mp4$/i,'.png'),baseVideosUrl+currentPath).href;const exists=await imageExists(candidate,2500);item.thumbUrl=exists?candidate:defaultFolderDataUrl}catch(e){item.thumbUrl=defaultFolderDataUrl}}
      }else item.thumbUrl=defaultFolderDataUrl;
      renderGrid();
    }
  }

  async function imageExists(url,timeout=4000){return new Promise(resolve=>{const img=new Image();let done=false; img.onload=()=>{if(done)return;done=true;resolve(true)}; img.onerror=()=>{if(done)return;done=true;resolve(false)}; img.src=url; setTimeout(()=>{if(done)return;done=true;resolve(false)},timeout)})}

  function renderGrid(){
    grid.innerHTML='';
    if(!library.length)return;
    const list=[...library]
    for(const item of list){
      const card=document.createElement('div'); card.className='card';
      const thumb=document.createElement('div'); thumb.className='thumb';
      if(item.thumbUrl){const img=document.createElement('img'); img.src=item.thumbUrl; img.alt=item.name; thumb.appendChild(img)}else{const ph=document.createElement('div'); ph.style.color='var(--muted)'; ph.style.fontSize='13px'; ph.textContent=item.type==='dir'?'Folder':'Brak miniaturki'; thumb.appendChild(ph)}
      if(item.type==='dir'){const folderBadge=document.createElement('div'); folderBadge.style.position='absolute'; folderBadge.style.left='8px'; folderBadge.style.top='8px'; folderBadge.innerHTML=`<svg class="folder-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7a2 2 0 0 1 2-2h3l2 2h7a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" fill="#ffd166"/></svg>`; thumb.appendChild(folderBadge)}
      const meta=document.createElement('div'); meta.className='meta';
      const title=document.createElement('div'); title.className='title'; title.textContent=item.name+(item.type==='dir'?'/':'');
      const sub=document.createElement('div'); sub.className='sub'; sub.textContent=item.type==='dir'?'Katalog':`${formatDuration(item.duration)} • ${item.size?humanSize(item.size):'—'}`;
      meta.appendChild(title); meta.appendChild(sub); card.appendChild(thumb); card.appendChild(meta);
      card.addEventListener('click',()=>{if(item.type==='dir'){const newPath=(currentPath?currentPath:'')+encodeURIComponent(item.name)+'/';navigateTo(newPath)}else openPlayer(item)});
      grid.appendChild(card);
    }
  }

  function openPlayer(item){
    // zamknij i posprzątaj poprzedni opis (jeśli był)
    removeDescContent();

    modalTitle.textContent = item.name;
    modalMeta.textContent = '—';

    // jeśli opis istnieje, pokaż przycisk (bez żadnego tekstu pod nim)
    const descText = item.description || '';
    if(descText && descText.trim().length){
      descToggleRow.style.display = 'flex';
      toggleDescBtn.textContent = 'Pokaż opis';
      toggleDescBtn.setAttribute('aria-expanded','false');
      descWrapper.classList.remove('open');
      descWrapper.setAttribute('aria-hidden','true');
    } else {
      descToggleRow.style.display = 'none';
      descWrapper.classList.remove('open');
      descWrapper.setAttribute('aria-hidden','true');
    }

    videoPlayer.pause();
    videoPlayer.removeAttribute('src');
    videoPlayer.load();

    modal.classList.add('open');

    if(item.url.endsWith('.m3u8')){
      if(Hls.isSupported()){
        const hls = new Hls();
        hls.loadSource(item.url);
        hls.attachMedia(videoPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED, () => videoPlayer.play().catch(() => {}));
      } else if(videoPlayer.canPlayType('application/vnd.apple.mpegurl')){
        videoPlayer.src = item.url;
        videoPlayer.addEventListener('loadedmetadata', () => videoPlayer.play());
      }
    } else {
      console.warn('Nieobsługiwany format, tylko .m3u8 jest dozwolone');
    }

    // local helper closure to hold description for toggle handler
    descWrapper._pendingDescription = descText;
  }

  // toggle opis: dynamiczne tworzenie i usuwanie elementu z opisem
  toggleDescBtn.addEventListener('click', () => {
    const isOpen = descWrapper.classList.contains('open');
    if(isOpen){
      // zamknij i usuń element z DOM
      removeDescContent();
      toggleDescBtn.textContent = 'Pokaż opis';
      toggleDescBtn.setAttribute('aria-expanded','false');
      descWrapper.classList.remove('open');
      descWrapper.setAttribute('aria-hidden','true');
    } else {
      // utwórz element z opisem tylko teraz
      const descText = descWrapper._pendingDescription || '';
      if(descText && descText.trim()){
        const content = document.createElement('div');
        content.id = 'descContent';
        // escape HTML then replace newlines -> <br>
        content.innerHTML = escapeHtml(descText).replace(/\n/g,'<br>');
        // dodaj do wrappera
        descWrapper.appendChild(content);
        // otwórz
        descWrapper.classList.add('open');
        descWrapper.setAttribute('aria-hidden','false');
        toggleDescBtn.textContent = 'Ukryj opis';
        toggleDescBtn.setAttribute('aria-expanded','true');
      }
    }
  });

  function removeDescContent(){
    const existing = document.getElementById('descContent');
    if(existing && existing.parentNode) existing.parentNode.removeChild(existing);
    // usuń też przechowywany tekst (nie koniecznie, ale czyści stan)
    //descWrapper._pendingDescription = '';
    descWrapper.classList.remove('open');
    descWrapper.setAttribute('aria-hidden','true');
  }

  async function playMultipartVideo(parts){
    if(!parts?.length)return;
    const mediaSource=new MediaSource();
    videoPlayer.src=URL.createObjectURL(mediaSource);
    modal.classList.add('open');
    mediaSource.addEventListener('sourceopen',async ()=>{
      const mime='video/mp4; codecs="avc1.64001E, mp4a.40.2"';
      const sb=mediaSource.addSourceBuffer(mime);
      for(let i=0;i<parts.length;i++){try{const res=await fetch(parts[i]);const buf=await res.arrayBuffer();await appendBufferAsync(sb,buf)}catch(e){console.error('Fragment error',parts[i],e)}}
      if(mediaSource.readyState==='open')mediaSource.endOfStream();
      videoPlayer.play().catch(()=>{});
    });
  }

  function appendBufferAsync(sb,buf){return new Promise(resolve=>{sb.addEventListener('updateend',resolve,{once:true});sb.appendBuffer(buf)})}

  function closeModal(){videoPlayer.pause(); videoPlayer.removeAttribute('src'); videoPlayer.load(); modal.classList.remove('open'); removeDescContent();}
  function goUp(){if(!currentPath)return; const parts=currentPath.replace(/\/$/,'').split('/'); parts.pop(); navigateTo(parts.length?parts.join('/')+'/':'')}

  refreshBtn.addEventListener('click',()=>loadLibrary());
  closeBtn.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal)closeModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});
  upBtn.addEventListener('click',goUp);

  renderBreadcrumb();
  await loadLibrary();

  // helper: escape HTML
  function escapeHtml(unsafe) {
    return (unsafe||'')
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

})();
</script>
</body>
</html>
