<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Jellyfin â€” klient HTML (client-side)</title>
  <style>
    :root{
      --bg:#0f1115; --card:#16181c; --muted:#9aa0a6; --accent:#ff6b6b; --glass: rgba(255,255,255,0.03);
      --radius:12px; --gap:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#0b0c0f, #0f1115); color:#e6eef6;}
    header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid rgba(255,255,255,0.03);}
    h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
    .controls{display:flex;gap:10px;align-items:center}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:inherit;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.02);font-weight:500}
    .dropzone{margin:18px auto 0;max-width:1100px;padding:16px;border-radius:12px;border:2px dashed rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .dropzone .left{display:flex;gap:14px;align-items:center}
    .dropzone p{margin:0;color:var(--muted)}
    #file-input{display:none}

    main{max-width:1200px;margin:20px auto;padding:0 20px}
    .grid{display:grid;grid-template-columns: repeat(auto-fill,minmax(180px,1fr));gap:var(--gap)}

    .card{background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.6);transition:transform .18s ease, box-shadow .18s ease;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 38px rgba(0,0,0,0.6)}
    .thumb{position:relative;height:108px;background:linear-gradient(180deg,#111219,#0f1115);display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:108px;object-fit:cover;display:block}
    .thumb .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .12s ease}
    .card:hover .thumb .play-overlay{opacity:1;background:linear-gradient(0deg, rgba(0,0,0,0.45), rgba(0,0,0,0.05))}
    .meta{padding:10px 12px}
    .title{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);margin-top:6px}

    .empty{max-width:1100px;margin:24px auto;padding:20px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:center;color:var(--muted)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));z-index:60;padding:30px}
    .modal.open{display:flex}
    .player-wrap{width:min(1100px,95%);background:#0b0c0f;border-radius:12px;padding:12px;}
    .player-top{display:flex;align-items:center;justify-content:space-between;padding:6px 8px}
    .player-top .info{display:flex;gap:12px;align-items:center}
    .close-btn{background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}
    video{width:100%;border-radius:8px;background:black}

    /* smaller screens */
    @media (max-width:540px){
      .thumb{height:86px}
      .thumb img{height:86px}
    }

    /* spinner */
    .spinner{width:36px;height:36px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <h1>Mini Jellyfin <span style="color:var(--muted);font-size:12px">client-side only</span></h1>
    <div class="controls">
      <label for="file-input"><button title="Dodaj pliki">âž• Dodaj pliki</button></label>
      <button id="clear-btn" class="secondary" title="WyczyÅ›Ä‡ listÄ™">ðŸ—‘ WyczyÅ›Ä‡</button>
    </div>
  </header>

  <div class="dropzone" id="dropzone">
    <div class="left">
      <div style="width:56px;height:56px;border-radius:8px;background:linear-gradient(180deg,#121317,#0d0f11);display:flex;align-items:center;justify-content:center;font-weight:700">MP4</div>
      <div>
        <p style="font-weight:600;margin-bottom:4px">PrzeciÄ…gnij i upuÅ›Ä‡ pliki .mp4 lub uÅ¼yj przycisku <strong>Dodaj pliki</strong></p>
        <p style="margin:0;color:var(--muted);font-size:13px">Miniaturki i metadane generowane po stronie klienta â€” nic nie opuszcza Twojej przeglÄ…darki.</p>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <div id="status" style="color:var(--muted);font-size:13px">Brak plikÃ³w</div>
      <input id="file-input" type="file" accept="video/mp4" multiple />
    </div>
  </div>

  <main>
    <div id="empty" class="empty">Dodaj pliki, aby zobaczyÄ‡ listÄ™ filmÃ³w.</div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <!-- modal player -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="player-wrap" role="document">
      <div class="player-top">
        <div class="info"><strong id="modal-title">TytuÅ‚</strong><div id="modal-sub" style="color:var(--muted);font-size:13px"></div></div>
        <div style="display:flex;gap:8px;align-items:center"><button class="close-btn" id="close-modal">âœ•</button></div>
      </div>
      <video id="player" controls playsinline></video>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file-input');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const status = document.getElementById('status');
    const dropzone = document.getElementById('dropzone');
    const modal = document.getElementById('modal');
    const player = document.getElementById('player');
    const modalTitle = document.getElementById('modal-title');
    const modalSub = document.getElementById('modal-sub');
    const closeModalBtn = document.getElementById('close-modal');

    // cache thumbnails and urls
    const library = [] // {file, url, thumb, duration, size}

    function humanSize(bytes){
      if(bytes<1024) return bytes+" B";
      const units=['KB','MB','GB','TB']; let i= -1; do{ bytes = bytes/1024; i++; } while(bytes>=1024 && i<units.length-1);
      return bytes.toFixed( (bytes>=10?0:1) ) + ' ' + units[i];
    }

    async function makeThumbnail(file){
      return new Promise((resolve)=>{
        const url = URL.createObjectURL(file);
        const v = document.createElement('video');
        v.preload = 'metadata';
        v.src = url;

        // handle metadata (duration) and seeking
        v.addEventListener('loadedmetadata', () => {
          const dur = v.duration || 0;
          const seekTo = Math.min(2, Math.max(0.1, dur/3));

          // on some browsers we must wait for seeked
          const onSeeked = () => {
            try{
              const canvas = document.createElement('canvas');
              const w = 320; const h = Math.round(w * 9 / 16);
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(v, 0, 0, w, h);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              URL.revokeObjectURL(url);
              resolve({thumb:dataUrl, duration:dur});
            }catch(err){
              // fallback: resolve without thumb
              URL.revokeObjectURL(url);
              resolve({thumb:null, duration:dur});
            }
          };

          // if seek is supported
          v.currentTime = seekTo;
          v.addEventListener('seeked', onSeeked, {once:true});

          // safety: if seek doesn't happen in time, fallback
          setTimeout(()=>{
            if(!v.seeking) return; // already seeked
            try{
              const canvas = document.createElement('canvas');
              const w = 320; const h = Math.round(w * 9 / 16);
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(v, 0, 0, w, h);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
              URL.revokeObjectURL(url);
              resolve({thumb:dataUrl, duration:v.duration||0});
            }catch(e){
              URL.revokeObjectURL(url);
              resolve({thumb:null, duration:v.duration||0});
            }
          }, 2200);
        });

        v.addEventListener('error', ()=>{
          URL.revokeObjectURL(url);
          resolve({thumb:null, duration:0});
        });
      });
    }

    async function addFiles(files){
      const arr = Array.from(files).filter(f=>f.type === 'video/mp4' || f.name.toLowerCase().endsWith('.mp4'));
      if(!arr.length) return;

      status.textContent = `GenerujÄ™ miniaturek... (${arr.length})`;

      for(const file of arr){
        const idx = library.findIndex(x=>x.file.name===file.name && x.file.size===file.size);
        if(idx !== -1) continue; // skip duplicates
        const placeholder = {file, url:URL.createObjectURL(file), thumb:null, duration:0, size:file.size};
        library.push(placeholder);
        renderGrid();

        // generate thumb + duration
        try{
          const res = await makeThumbnail(file);
          placeholder.thumb = res.thumb;
          placeholder.duration = res.duration || 0;
        }catch(e){
          // ignore
        }
        renderGrid();
      }

      updateStatus();
    }

    function formatDuration(sec){
      if(!sec || isNaN(sec)) return 'â€”';
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      const m = Math.floor((sec/60)%60).toString().padStart(2,'0');
      const h = Math.floor(sec/3600);
      return h? `${h}:${m}:${s}` : `${m}:${s}`;
    }

    function renderGrid(){
      grid.innerHTML = '';
      if(!library.length){ empty.style.display='block'; return; }
      empty.style.display='none';

      for(const item of library){
        const card = document.createElement('div'); card.className='card';
        const thumb = document.createElement('div'); thumb.className='thumb';
        if(item.thumb){
          const img = document.createElement('img'); img.src = item.thumb; img.alt = item.file.name; thumb.appendChild(img);
        }else{
          const placeholder = document.createElement('div'); placeholder.style.padding='12px'; placeholder.style.fontSize='13px'; placeholder.style.color='var(--muted)'; placeholder.textContent = 'Miniaturka...';
          const spinner = document.createElement('div'); spinner.className='spinner'; spinner.style.marginLeft='10px';
          const cont = document.createElement('div'); cont.style.display='flex'; cont.style.alignItems='center'; cont.style.justifyContent='center'; cont.style.gap='10px'; cont.appendChild(placeholder); cont.appendChild(spinner);
          thumb.appendChild(cont);
        }

        const overlay = document.createElement('div'); overlay.className='play-overlay';
        overlay.innerHTML = `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="rgba(255,255,255,0.08)" stroke-width="1" fill="rgba(0,0,0,0.32)"/><path d="M9 17V7l8 5-8 5z" fill="white"/></svg>`;
        thumb.appendChild(overlay);

        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('div'); title.className='title'; title.textContent = item.file.name;
        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${formatDuration(item.duration)} â€¢ ${humanSize(item.size)}`;
        meta.appendChild(title); meta.appendChild(sub);

        card.appendChild(thumb); card.appendChild(meta);

        // click -> open modal with player
        card.addEventListener('click', ()=> openPlayer(item));

        grid.appendChild(card);
      }
    }

    function updateStatus(){
      status.textContent = `${library.length} plikÃ³w`;
    }

    function openPlayer(item){
      modalTitle.textContent = item.file.name;
      modalSub.textContent = `${formatDuration(item.duration)} â€¢ ${humanSize(item.size)}`;
      player.src = item.url;
      player.currentTime = 0;
      modal.classList.add('open');
      setTimeout(()=>player.play().catch(()=>{}),100);
    }

    function closeModal(){
      player.pause(); player.removeAttribute('src'); player.load();
      modal.classList.remove('open');
    }

    // file input
    fileInput.addEventListener('change', (e)=> addFiles(e.target.files));

    // drag-drop
    ['dragenter','dragover'].forEach(evt=>{
      dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.style.borderColor='rgba(255,255,255,0.08)'; });
    });
    ['dragleave','drop'].forEach(evt=>{
      dropzone.addEventListener(evt, (e)=>{ e.preventDefault(); dropzone.style.borderColor='rgba(255,255,255,0.03)'; });
    });
    dropzone.addEventListener('drop', (e)=>{
      const dt = e.dataTransfer; if(!dt) return; addFiles(dt.files);
    });

    // modal controls
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // clear
    document.getElementById('clear-btn').addEventListener('click', ()=>{
      // revoke urls
      library.forEach(x=>{ try{ URL.revokeObjectURL(x.url); }catch(e){} });
      library.length = 0; renderGrid(); updateStatus();
    });

    // accessibility: keyboard file dialog via Enter on dropzone
    dropzone.tabIndex = 0;
    dropzone.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') fileInput.click(); });

    // initial render
    renderGrid();
  </script>
</body>
</html>
